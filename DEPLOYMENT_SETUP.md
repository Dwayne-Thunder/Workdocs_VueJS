# Настройка автоматического развертывания

> **Важно**: Workflow настроен точно по образцу оригинального файла из [CodeQuartzWorkshop/Site](https://raw.githubusercontent.com/CodeQuartzWorkshop/Site/refs/heads/main/.github/workflows/deploy.yml)

## Необходимые секреты GitHub

Для работы автоматического развертывания необходимо настроить следующие секреты в настройках репозитория GitHub:

### Перейдите в настройки репозитория:

1. Откройте ваш репозиторий на GitHub
2. Перейдите в `Settings` → `Secrets and variables` → `Actions`
3. Нажмите `New repository secret`

### Добавьте следующие секреты:

#### `SERVER_HOST`

- **Описание**: IP-адрес или доменное имя вашего сервера
- **Пример**: `45.93.200.116` или `your-domain.com`

#### `SERVER_USER`

- **Описание**: Имя пользователя для SSH подключения к серверу
- **Пример**: `root` или `ubuntu`

#### `SERVER_SSH_KEY`

- **Описание**: Приватный SSH ключ для подключения к серверу
- **Как получить**:
  1. На сервере выполните: `cat ~/.ssh/id_rsa` (или путь к вашему ключу)
  2. Скопируйте весь вывод включая `-----BEGIN OPENSSH PRIVATE KEY-----` и `-----END OPENSSH PRIVATE KEY-----`

## Настройка сервера

### Предварительные требования:

1. Node.js 18+ установлен на сервере
2. PM2 установлен глобально: `npm install -g pm2`
3. SSH ключи настроены для доступа к серверу
4. Папка `/var/www/workdocs/` создана и доступна для записи

### Команды для настройки сервера:

```bash
# Создание директории для проекта
sudo mkdir -p /var/www/workdocs
sudo chown $USER:$USER /var/www/workdocs

# Установка PM2 глобально
npm install -g pm2

# Настройка автозапуска PM2
pm2 startup
```

## Структура развертывания

После развертывания на сервере будет создана следующая структура:

```
/var/www/workdocs/
├── dist/                 # Собранные файлы фронтенда
├── server.js            # Серверное приложение
├── package.json         # Зависимости
├── ecosystem.config.cjs # Конфигурация PM2
├── uploads/             # Загруженные файлы
├── logs/                # Логи приложения
└── .env                 # Переменные окружения
```

## Мониторинг

После развертывания вы можете проверить статус приложения:

```bash
# Проверка статуса PM2
pm2 status

# Просмотр логов
pm2 logs workdocs-app

# Перезапуск приложения
pm2 restart workdocs-app
```

## Автоматический откат

В случае ошибки развертывания автоматически выполняется откат к предыдущей версии из бэкапа.

## Примечания

- Приложение будет доступно на порту 3001
- Бэкапы создаются автоматически перед каждым развертыванием
- Логи сохраняются в папке `/var/www/workdocs/logs/`
- PM2 автоматически перезапускает приложение при сбоях
